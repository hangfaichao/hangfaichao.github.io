---
title: JAVA内存区域与内存溢出异常
date: 2019-09-21 10:04:35
tags:
category: JVM
---

c++需要开发者为每一个new操作去写配对的delete/free代码，而Java是由虚拟机来管理内存，不容易出现内存泄漏和内存溢出问题。

## Java虚拟机运行时数据区域

运行时数据区域包括：程序计数器、虚拟机栈、本地方法栈、Java堆、方法区

- 程序计数器
  - 作用：当前线程所执行的字节码的行号指示器
  - 状态：线程私有
  - 特点：如果正在执行的是Native方法，这个计数器值则为空。
  - 异常：此内存区域是唯一一个在Java虚拟机规范中没有规定任何OutOfMemoryError情况的区域
- Java虚拟机栈
  - 作用：描述Java方法执行的内存模型：每个方法在执行的同时会创建一个栈帧用于存储局部变量表（存放各种基本数据类型）、操作数栈、动态链接、方法出口等信息。
  - 状态：线程私有
  - 特点：进入方法时，这个方法需要在帧中分配多大的局部变量空间时完全确定的，在运行期间不会改变
  - 异常
    - 线程请求的栈深度大于虚拟机允许的深度，StakOverflowError
    - 虚拟机栈动态扩展无法申请到足够的内存，OutOfMemoryError
- 本地方法栈
  - 作用：与虚拟机栈作用类似
  - 状态：线程私有
  - 特点：区别是虚拟机栈为Java方法服务，本地方法栈为Native方法服务
  - 异常：（与虚拟机栈一样：StakOverflowError、OutOfMemoryError）
- Java堆
  - 作用：存放对象实例
  - 状态：线程共享
  - 特点：
    - 是垃圾收集器管理的主要区域，也被称为“GC堆”
    - Java堆可以物理不连续，只要逻辑连续即可
  - 异常：堆无法再扩展时，OutOfMemoryError
- 方法区
  - 作用：存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据
  - 状态：线程共享
  - 特点：可以使用永久代来实现方法区
  - 异常：当方法区无法满足内存分配需求时，OutOfMemoryError
- 运行时常量池
  - 作用：方法区的一部分，存放Class文件中的常量池信息（编译期生成的各种字面量和符号引用）
  - 状态：线程共享
  - 特点：动态性（并非预置入Class文件中常量池的内容才能进去方法区运行常量池，运行期间也可能将新的常量放入池中（String类的intern()方法）
  - 异常：当常量池无法申请到内存时，OutOfMemoryError
- 直接内存
  - 并不是虚拟机运行数据区的一部分，也不是Java虚拟机规范中定义的内存区域
  - 使用Native函数库直接分配堆外内存，然后通过一个存储在Java堆中的DIrectByteBuffer对象作为这块内存的引用进行操作，这样能显著提高性能，避免了在Java堆和Native堆来回复制数据

